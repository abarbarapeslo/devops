# Nome do Workflow
name: CI/CD - Build, Push (ECR) e Deploy (Terraform)

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

# Permiss칫es globais para o OIDC (autentica칞칚o segura sem chaves)
permissions:
  id-token: write   # Necess치rio para o GitHub se autenticar na AWS
  contents: read    # Necess치rio para o 'actions/checkout'

# ===================================================================
# 游눠 VARI츼VEIS GLOBAIS
# Estas s칚o vari치veis de ambiente, N츾O segredos.
# ===================================================================
env:
  # 1. Mude isso para o nome do seu reposit칩rio no ECR
  ECR_REPOSITORY: "meu-app-devops"
  
  # 2. Mude isso para a sua regi칚o padr칚o
  AWS_REGION: "us-east-1"

# ===================================================================
# 游 JOBS (Trabalhos)
# ===================================================================
jobs:
  # -----------------------------------------------------------------
  # JOB 1: Constr칩i a imagem Docker e envia para o ECR
  # -----------------------------------------------------------------
  build-and-push:
    name: 1. Build e Push para ECR
    runs-on: ubuntu-latest

    # O 'outputs' permite passar o nome da imagem (tag) para o pr칩ximo job
    outputs:
      image_tag: ${{ steps.build-image.outputs.image_tag }}

    steps:
      - name: Checkout do c칩digo
        uses: actions/checkout@v4

      - name: Configurar credenciais AWS (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          # 游녢 LEIA ISSO! Esta vari치vel DEVE ser criada no GitHub
          # (Settings > Environments > New > vars.AWS_OIDC_ROLE_ARN)
          role-to-assume: ${{ vars.AWS_OIDC_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Login no Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Build, Tag e Push da imagem Docker
        id: build-image
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
        run: |
          # 1. Gera uma tag de imagem 칰nica (o hash curto do commit)
          IMAGE_TAG=$(echo $GITHUB_SHA | cut -c1-12)
          echo "IMAGE_TAG=${IMAGE_TAG}" >> $GITHUB_OUTPUT # Salva a tag para o 'outputs'

          # 2. Constr칩i a imagem
          #    -f aponta para o seu Dockerfile
          #    ./devops 칠 o "contexto" (a pasta onde o COPY . . ser치 executado)
          docker build -t $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG -f devops/Dockerfile ./devops
          
          # 3. Envia a imagem para o ECR
          docker push $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG

  # -----------------------------------------------------------------
  # JOB 2: Roda o Terraform para fazer o deploy da infra
  # -----------------------------------------------------------------
  deploy-infra:
    name: 2. Deploy da Infra (Terraform)
    runs-on: ubuntu-latest
    needs: build-and-push # S칩 roda DEPOIS que o Job 1 terminar

    steps:
      - name: Checkout do c칩digo
        uses: actions/checkout@v4

      - name: Configurar credenciais AWS (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          # 游녢 Usa a MESMA vari치vel de ambiente do GitHub
          role-to-assume: ${{ vars.AWS_OIDC_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Configurar Terraform
        uses: hashicorp/setup-terraform@v3

      - name: Terraform Init
        id: init
        # O 'working-directory' diz ao Terraform onde seus arquivos .tf est칚o
        working-directory: devops/infra
        run: terraform init

      - name: Terraform Plan
        id: plan
        working-directory: devops/infra
        run: |
          # 游녢 AQUI EST츼 A M츼GICA:
          # Injeta a tag da imagem (do Job 1) como uma vari치vel no Terraform
          terraform plan -out=tfplan \
            -var="image_tag=${{ needs.build-and-push.outputs.image_tag }}"

      - name: Terraform Apply
        # S칩 aplica de verdade se for um push na branch 'main'
        if: github.ref == 'refs/heads/main'
        working-directory: devops/infra
        run: |
          terraform apply -auto-approve tfplan